# SQL CASE Statement Guide

The SQL CASE statement is a versatile conditional expression that allows you to implement if-then-else logic directly in your queries. It's essential for data transformation, categorization, and conditional operations.

## Table of Contents

- [[#What is CASE Statement?|What is CASE Statement?]]
- [[#CASE Syntax Types|CASE Syntax Types]]
- [[#Categorize Data|Categorize Data]]
- [[#Mapping Values|Mapping Values]]
- [[#Quick Form Syntax|Quick Form Syntax]]
- [[#Handling NULL Values|Handling NULL Values]]
- [[#Conditional Aggregation|Conditional Aggregation]]
- [[#Best Practices|Best Practices]]

---

## What is CASE Statement?

The CASE statement evaluates conditions and returns different values based on the results. It's like an if-then-else structure in programming languages but designed for SQL queries.

> [!info] Key Benefits
> 
> - Transform data on-the-fly without modifying source tables
> - Create calculated columns based on conditions
> - Handle NULL values gracefully
> - Perform conditional aggregations
> - Simplify complex reporting logic

---

## CASE Syntax Types

### Standard CASE Syntax

```sql
CASE
    WHEN condition1 THEN result1
    WHEN condition2 THEN result2
    ELSE default_result
END
```

### Simple CASE Syntax (Quick Form)

```sql
CASE column_name
    WHEN value1 THEN result1
    WHEN value2 THEN result2
    ELSE default_result
END
```

> [!note] When to Use Each
> 
> - **Standard CASE**: Use for complex conditions with different operators (`>`, `<`, `LIKE`, etc.)
> - **Simple CASE**: Use for exact value matching (equality comparisons only)

---

## Categorize Data

### Use Case: Sales Performance Classification

**Objective**: Create performance categories based on sales amounts and analyze total sales by category.

```sql
SELECT
    Category,
    SUM(Sales) AS TotalSales
FROM (
    SELECT
        OrderID,
        Sales,
        CASE
            WHEN Sales > 50 THEN 'High'
            WHEN Sales > 20 THEN 'Medium'
            ELSE 'Low'
        END AS Category
    FROM Sales.Orders
) AS t
GROUP BY Category
ORDER BY TotalSales DESC;
```

**Sample Output:**

|Category|TotalSales|
|---|---|
|High|125,450|
|Medium|89,230|
|Low|45,120|

### How It Works:

1. **Inner Query**: Categorizes each order based on sales amount
2. **Outer Query**: Groups by category and sums total sales
3. **Logic Flow**:
    - Sales > 50 → 'High'
    - Sales 20-50 → 'Medium'
    - Sales ≤ 20 → 'Low'

> [!tip] Performance Tip When using CASE in subqueries, consider creating a view or CTE for better readability and potential reuse.

---

## Mapping Values

### Use Case: Country Code Abbreviation

**Objective**: Convert full country names to standardized abbreviations for reporting.

```sql
SELECT
    CustomerID,
    FirstName,
    LastName,
    Country,
    CASE 
        WHEN Country = 'Germany' THEN 'DE'
        WHEN Country = 'USA'     THEN 'US'
        ELSE 'n/a'
    END AS CountryAbbr
FROM Sales.Customers;
```

**Sample Output:**

|CustomerID|FirstName|LastName|Country|CountryAbbr|
|---|---|---|---|---|
|1001|John|Smith|USA|US|
|1002|Hans|Mueller|Germany|DE|
|1003|Pierre|Dubois|France|n/a|

### Key Points:

- **ELSE clause**: Handles unmapped values gracefully
- **Data standardization**: Converts varying formats to consistent codes
- **Flexibility**: Easy to extend with additional country mappings

---

## Quick Form Syntax

### Use Case: Comparing Standard vs Simple CASE

**Objective**: Demonstrate both syntax types for the same mapping logic.

```sql
SELECT
    CustomerID,
    FirstName,
    LastName,
    Country,
    -- Standard CASE (with conditions)
    CASE 
        WHEN Country = 'Germany' THEN 'DE'
        WHEN Country = 'USA'     THEN 'US'
        ELSE 'n/a'
    END AS CountryAbbr,
    -- Simple CASE (direct value matching)
    CASE Country
        WHEN 'Germany' THEN 'DE'
        WHEN 'USA'     THEN 'US'
        ELSE 'n/a'
    END AS CountryAbbr2
FROM Sales.Customers;
```

**Sample Output:**

|CustomerID|Country|CountryAbbr|CountryAbbr2|
|---|---|---|---|
|1001|USA|US|US|
|1002|Germany|DE|DE|
|1003|France|n/a|n/a|

> [!important] Simple CASE Limitations Simple CASE can only check for equality (`=`). For complex conditions like ranges or pattern matching, use standard CASE.

---

## Handling NULL Values

### Use Case: Clean Score Calculation

**Objective**: Handle NULL scores by treating them as 0 and compare averages with/without NULL handling.

```sql
SELECT
    CustomerID,
    LastName,
    Score,
    CASE
        WHEN Score IS NULL THEN 0
        ELSE Score
    END AS ScoreClean,
    AVG(
        CASE
            WHEN Score IS NULL THEN 0
            ELSE Score
        END
    ) OVER () AS AvgCustomerClean,
    AVG(Score) OVER () AS AvgCustomer
FROM Sales.Customers;
```

**Sample Output:**

|CustomerID|LastName|Score|ScoreClean|AvgCustomerClean|AvgCustomer|
|---|---|---|---|---|---|
|1001|Smith|85|85|72.5|87.0|
|1002|Mueller|NULL|0|72.5|87.0|
|1003|Johnson|90|90|72.5|87.0|

### Analysis:

- **ScoreClean**: NULL values converted to 0
- **AvgCustomerClean**: Average including NULLs as 0 (72.5)
- **AvgCustomer**: Average excluding NULLs entirely (87.0)

> [!warning] NULL Handling Impact Converting NULLs to 0 vs excluding them can significantly affect calculations. Choose the approach that makes business sense for your data.

---

## Conditional Aggregation

### Use Case: High-Value Order Analysis

**Objective**: Count orders with sales > 30 per customer while showing total order count.

```sql
SELECT
    CustomerID,
    SUM(
        CASE
            WHEN Sales > 30 THEN 1
            ELSE 0
        END
    ) AS TotalOrdersHighSales,
    COUNT(*) AS TotalOrders
FROM Sales.Orders
GROUP BY CustomerID;
```

**Sample Output:**

|CustomerID|TotalOrdersHighSales|TotalOrders|
|---|---|---|
|1001|3|5|
|1002|1|4|
|1003|2|3|

### How It Works:

1. **CASE logic**: Returns 1 for sales > 30, otherwise 0
2. **SUM()**: Adds up all the 1s (counting high-sales orders)
3. **COUNT(*)**: Counts all orders regardless of sales amount

> [!tip] Alternative Approach You could also use: `COUNT(CASE WHEN Sales > 30 THEN 1 END)` which counts non-NULL values only.

---

## Best Practices

### 1. Order Conditions Properly

```sql
-- ✅ Correct: Most specific first
CASE
    WHEN Sales > 100 THEN 'Premium'
    WHEN Sales > 50 THEN 'High'
    WHEN Sales > 20 THEN 'Medium'
    ELSE 'Low'
END

-- ❌ Wrong: Broad condition first catches everything
CASE
    WHEN Sales > 20 THEN 'Medium'  -- This catches Sales > 100 too!
    WHEN Sales > 100 THEN 'Premium'
    ELSE 'Low'
END
```

### 2. Always Include ELSE

```sql
-- ✅ Good: Handles unexpected values
CASE
    WHEN Country = 'USA' THEN 'US'
    WHEN Country = 'Germany' THEN 'DE'
    ELSE 'Unknown'  -- Prevents NULL results
END

-- ❌ Risky: Missing ELSE returns NULL for unmatched values
CASE
    WHEN Country = 'USA' THEN 'US'
    WHEN Country = 'Germany' THEN 'DE'
END
```

### 3. Use Consistent Data Types

```sql
-- ✅ Good: All results are same type
CASE
    WHEN Score >= 90 THEN 'A'
    WHEN Score >= 80 THEN 'B'
    ELSE 'C'
END

-- ❌ Bad: Mixed types can cause issues
CASE
    WHEN Score >= 90 THEN 'A'
    WHEN Score >= 80 THEN 'B'
    ELSE 0  -- Number instead of string
END
```

### 4. Consider Performance

- **Complex CASE in WHERE**: May prevent index usage
- **Repeated CASE logic**: Consider creating computed columns or views
- **Large CASE statements**: Consider lookup tables instead

---

## Quick Reference

|Use Case|Syntax Pattern|Best For|
|---|---|---|
|**Categorization**|`CASE WHEN condition THEN category`|Creating groups, performance tiers|
|**Value Mapping**|`CASE column WHEN value THEN replacement`|Code translation, standardization|
|**NULL Handling**|`CASE WHEN column IS NULL THEN default`|Data cleaning, calculations|
|**Conditional Aggregation**|`SUM(CASE WHEN condition THEN 1 ELSE 0 END)`|Filtered counting, complex metrics|

---

## Common CASE Patterns

```sql
-- Pattern 1: Nested aggregation with CASE
SELECT 
    Region,
    AVG(CASE WHEN Score IS NOT NULL THEN Score ELSE 0 END) as AvgScore
FROM Sales.Customers 
GROUP BY Region;

-- Pattern 2: Multiple conditions in one CASE
SELECT 
    CustomerID,
    CASE 
        WHEN Score > 90 AND Orders > 10 THEN 'VIP'
        WHEN Score > 70 OR Orders > 5 THEN 'Regular'
        ELSE 'New'
    END as CustomerTier
FROM Sales.Customers;

-- Pattern 3: CASE in ORDER BY
SELECT * 
FROM Sales.Orders
ORDER BY 
    CASE 
        WHEN Priority = 'High' THEN 1
        WHEN Priority = 'Medium' THEN 2
        ELSE 3
    END;
```

---

## Tags

#sql #case-statement #conditional-logic #data-transformation #aggregation #null-handling #categorization