# SQL NULL Functions - Complete Guide

A comprehensive guide to mastering NULL value handling in SQL. Learn essential techniques for data aggregation, mathematical operations, sorting, and comparisons while maintaining data integrity.

## Table of Contents

- [[#Understanding NULL Values|Understanding NULL Values]]
- [[#NULL in Data Aggregation|NULL in Data Aggregation]]
- [[#NULL in Mathematical Operations|NULL in Mathematical Operations]]
- [[#NULL in Sorting Operations|NULL in Sorting Operations]]
- [[#Division by Zero Protection|Division by Zero Protection]]
- [[#NULL Comparison Operations|NULL Comparison Operations]]
- [[#Finding Missing Relationships|Finding Missing Relationships]]
- [[#NULL vs Empty vs Spaces|NULL vs Empty vs Spaces]]
- [[#Quick Reference Guide|Quick Reference Guide]]

---

## Understanding NULL Values

> [!info] What is NULL? NULL represents the **absence of a value** - it's not zero, not an empty string, and not a space. NULL means "unknown" or "missing data" and requires special handling in SQL operations.

### Key NULL Principles

- NULL + anything = NULL
- NULL compared to anything = UNKNOWN (not TRUE or FALSE)
- Aggregate functions typically ignore NULL values
- NULL values affect sorting and mathematical operations

---

## NULL in Data Aggregation

### Problem: NULL Values in Averages

When calculating averages, NULL values are excluded, which can skew results.

```sql
-- TASK 1: Find average scores handling NULL values
SELECT
    CustomerID,
    Score,
    COALESCE(Score, 0) AS Score2,
    AVG(Score) OVER () AS AvgScores,
    AVG(COALESCE(Score, 0)) OVER () AS AvgScores2
FROM Sales.Customers;
```

#### Expected Output:

```
CustomerID | Score | Score2 | AvgScores | AvgScores2
-----------|-------|--------|-----------|------------
1          | 85    | 85     | 87.5      | 70.0
2          | 90    | 90     | 87.5      | 70.0
3          | NULL  | 0      | 87.5      | 70.0
4          | 85    | 85     | 87.5      | 70.0
```

> [!tip] COALESCE Function `COALESCE(value1, value2, ...)` returns the first non-NULL value from the list. Perfect for providing default values for NULL data.

### Key Insights:

- **AvgScores**: Excludes NULL values (average of 85, 90, 85 = 87.5)
- **AvgScores2**: Includes NULL as 0 (average of 85, 90, 0, 85 = 70.0)

---

## NULL in Mathematical Operations

### Problem: String Concatenation and Arithmetic with NULL

NULL values in calculations result in NULL output, breaking expected results.

```sql
-- TASK 2: Handle NULL in string concatenation and arithmetic
SELECT
    CustomerID,
    FirstName,
    LastName,
    FirstName + ' ' + COALESCE(LastName, '') AS FullName,
    Score,
    COALESCE(Score, 0) + 10 AS ScoreWithBonus
FROM Sales.Customers;
```

#### Expected Output:

```
CustomerID | FirstName | LastName | FullName    | Score | ScoreWithBonus
-----------|-----------|----------|-------------|-------|----------------
1          | John      | Smith    | John Smith  | 85    | 95
2          | Jane      | NULL     | Jane        | 90    | 100
3          | Bob       | Johnson  | Bob Johnson | NULL  | 10
```

> [!warning] NULL Concatenation Trap In many SQL databases, concatenating with NULL results in NULL:
> 
> - `'John' + ' ' + NULL = NULL`
> - Use `COALESCE` to handle NULL values in concatenation

---

## NULL in Sorting Operations

### Problem: Unpredictable NULL Ordering

NULL values can appear first or last in sorting, depending on the database system.

```sql
-- TASK 3: Control NULL positioning in sorting
SELECT
    CustomerID,
    Score
FROM Sales.Customers
ORDER BY CASE WHEN Score IS NULL THEN 1 ELSE 0 END, Score;
```

#### Expected Output:

```
CustomerID | Score
-----------|-------
1          | 75
4          | 85
2          | 90
3          | NULL
```

### Alternative Sorting Methods:

```sql
-- NULLs first
ORDER BY Score NULLS FIRST;

-- NULLs last
ORDER BY Score NULLS LAST;

-- Custom NULL handling
ORDER BY ISNULL(Score, 999), Score;
```

> [!note] Database Differences
> 
> - **SQL Server**: NULL values sort first by default
> - **PostgreSQL/Oracle**: Support `NULLS FIRST/LAST` syntax
> - **MySQL**: NULL values sort first

---

## Division by Zero Protection

### Problem: Division by Zero Errors

Division by zero causes runtime errors and stops query execution.

```sql
-- TASK 4: Safe division using NULLIF
SELECT
    OrderID,
    Sales,
    Quantity,
    Sales / NULLIF(Quantity, 0) AS Price
FROM Sales.Orders;
```

#### Expected Output:

```
OrderID | Sales | Quantity | Price
--------|-------|----------|-------
1001    | 150   | 3        | 50.00
1002    | 200   | 0        | NULL
1003    | 300   | 6        | 50.00
```

> [!tip] NULLIF Function `NULLIF(expression1, expression2)` returns NULL if both expressions are equal, otherwise returns the first expression.
> 
> Perfect for preventing division by zero: `Sales / NULLIF(Quantity, 0)`

### Alternative Approaches:

```sql
-- Using CASE statement
Sales / CASE WHEN Quantity = 0 THEN NULL ELSE Quantity END AS Price

-- Using IIF (SQL Server)
Sales / IIF(Quantity = 0, NULL, Quantity) AS Price
```

---

## NULL Comparison Operations

### Finding NULL and Non-NULL Values

Standard comparison operators (`=`, `!=`) don't work with NULL values.

```sql
-- TASK 5: Find customers with no scores
SELECT *
FROM Sales.Customers
WHERE Score IS NULL;
```

```sql
-- TASK 6: Find customers with scores
SELECT *
FROM Sales.Customers
WHERE Score IS NOT NULL;
```

#### Expected Outputs:

**Customers with NULL scores:**

```
CustomerID | FirstName | LastName | Score
-----------|-----------|----------|-------
3          | Bob       | Johnson  | NULL
5          | Alice     | NULL     | NULL
```

**Customers with scores:**

```
CustomerID | FirstName | LastName | Score
-----------|-----------|----------|-------
1          | John      | Smith    | 85
2          | Jane      | Doe      | 90
4          | Mike      | Brown    | 75
```

> [!warning] Common NULL Mistakes
> 
> ```sql
> -- ❌ Wrong: This returns no results
> WHERE Score = NULL
> 
> -- ❌ Wrong: This also returns no results  
> WHERE Score != NULL
> 
> -- ✅ Correct: Use IS NULL / IS NOT NULL
> WHERE Score IS NULL
> WHERE Score IS NOT NULL
> ```

---

## Finding Missing Relationships

### LEFT ANTI JOIN Pattern

Find records in one table that don't have corresponding records in another table.

```sql
-- TASK 7: Find customers who haven't placed any orders
SELECT
    c.*,
    o.OrderID
FROM Sales.Customers AS c
LEFT JOIN Sales.Orders AS o
    ON c.CustomerID = o.CustomerID
WHERE o.CustomerID IS NULL;
```

#### Expected Output:

```
CustomerID | FirstName | LastName | Score | OrderID
-----------|-----------|----------|-------|----------
3          | Bob       | Johnson  | NULL  | NULL
5          | Alice     | White    | 88    | NULL
```

### How LEFT ANTI JOIN Works:

1. **LEFT JOIN**: Returns all customers, with NULL for orders if no match exists
2. **WHERE o.CustomerID IS NULL**: Filters to only customers without orders
3. **Result**: Customers who have never placed an order

> [!tip] Alternative Methods
> 
> ```sql
> -- Using NOT EXISTS
> SELECT * FROM Sales.Customers c
> WHERE NOT EXISTS (
>     SELECT 1 FROM Sales.Orders o 
>     WHERE o.CustomerID = c.CustomerID
> );
> 
> -- Using NOT IN (be careful with NULLs)
> SELECT * FROM Sales.Customers
> WHERE CustomerID NOT IN (
>     SELECT CustomerID FROM Sales.Orders 
>     WHERE CustomerID IS NOT NULL
> );
> ```

---

## NULL vs Empty vs Spaces

### Understanding the Differences

```sql
-- TASK 8: Demonstrate NULL, empty string, and spaces
WITH Orders AS (
    SELECT 1 AS Id, 'A' AS Category UNION
    SELECT 2, NULL UNION
    SELECT 3, '' UNION
    SELECT 4, '  '
)
SELECT 
    *,
    DATALENGTH(Category) AS LenCategory,
    TRIM(Category) AS Policy1,
    NULLIF(TRIM(Category), '') AS Policy2,
    COALESCE(NULLIF(TRIM(Category), ''), 'unknown') AS Policy3
FROM Orders;
```

#### Expected Output:

```
Id | Category | LenCategory | Policy1 | Policy2 | Policy3
---|----------|-------------|---------|---------|----------
1  | A        | 1           | A       | A       | A
2  | NULL     | NULL        | NULL    | NULL    | unknown
3  |          | 0           |         | NULL    | unknown
4  |    (spaces) | 2        |         | NULL    | unknown
```

### Data Cleaning Strategy Breakdown:

|Step|Function|Purpose|
|---|---|---|
|**Policy1**|`TRIM(Category)`|Remove leading/trailing spaces|
|**Policy2**|`NULLIF(TRIM(Category), '')`|Convert empty strings to NULL|
|**Policy3**|`COALESCE(NULLIF(TRIM(...), ''), 'unknown')`|Provide default for missing data|

> [!info] Key Differences
> 
> - **NULL**: No value, `DATALENGTH()` returns NULL
> - **Empty String** `''`: Zero-length string, `DATALENGTH()` returns 0
> - **Spaces** `' '`: String with spaces, `DATALENGTH()` returns number of characters

---

## Quick Reference Guide

### NULL Handling Functions

|Function|Syntax|Purpose|Example|
|---|---|---|---|
|**COALESCE**|`COALESCE(val1, val2, ...)`|First non-NULL value|`COALESCE(Score, 0)`|
|**NULLIF**|`NULLIF(expr1, expr2)`|NULL if expressions equal|`NULLIF(Quantity, 0)`|
|**ISNULL**|`ISNULL(expr, replacement)`|Replace NULL (SQL Server)|`ISNULL(Score, 0)`|
|**NVL**|`NVL(expr, replacement)`|Replace NULL (Oracle)|`NVL(Score, 0)`|

### NULL Comparison Operators

```sql
-- Correct NULL comparisons
WHERE column IS NULL
WHERE column IS NOT NULL

-- Incorrect (returns no results)
WHERE column = NULL
WHERE column != NULL
```

### Common NULL Patterns

```sql
-- Safe division
column1 / NULLIF(column2, 0)

-- Default values
COALESCE(column, 'Default Value')

-- NULL-safe concatenation
CONCAT(first_name, ' ', COALESCE(last_name, ''))

-- NULL-aware sorting
ORDER BY CASE WHEN column IS NULL THEN 1 ELSE 0 END, column

-- Find missing relationships
FROM table1 t1
LEFT JOIN table2 t2 ON t1.id = t2.id
WHERE t2.id IS NULL
```

### Performance Tips

> [!tip] Optimization Guidelines
> 
> 1. **Index Considerations**: Most databases don't index NULL values
> 2. **WHERE Clauses**: `IS NULL` can use indexes, `= NULL` cannot
> 3. **Aggregations**: Consider whether to include/exclude NULLs
> 4. **Data Types**: Choose appropriate defaults during table design

---

## Best Practices

### 1. Design Phase

- Define clear NULL policies for each column
- Use NOT NULL constraints where appropriate
- Consider default values during table creation

### 2. Query Phase

- Always handle NULLs explicitly in calculations
- Use COALESCE for default values
- Be explicit about NULL sorting behavior

### 3. Data Quality

- Distinguish between "unknown" (NULL) and "empty" values
- Implement consistent data cleaning procedures
- Document NULL handling strategies for your team

---

## Common Pitfalls to Avoid

> [!danger] Critical Mistakes
> 
> 1. **Using `= NULL`** instead of `IS NULL`
> 2. **Forgetting NULL impact** in mathematical operations
> 3. **Inconsistent NULL handling** across similar queries
> 4. **Not considering NULLs** in JOIN conditions
> 5. **Mixing empty strings with NULLs** without clear strategy

---

## Tags

#sql #null-handling #data-quality #coalesce #nullif #joins #aggregation #sorting #mathematical-operations #best-practices